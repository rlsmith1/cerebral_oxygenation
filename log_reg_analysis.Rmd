---
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, comment = "", message = FALSE, warning = FALSE, fig.height = 8, fig.width = 10)

```

# Cerebral oxygenation in cerebral malaria: logistic regression analysis {.tabset}

```{r data}

library(tidyverse)

# read in data
df_hbox <- read.csv("Data/98 first visit records with cerebral oxygenation stats_trimmed.csv") %>% as_tibble()

# get rid of "Other"
df_hbox <- df_hbox %>% 
  filter(Status != "Other") %>% 
  mutate(Status = factor(Status, levels = c("HV", "UM", "CM")))

# identify duplicated rows (TM0003, TM2001)
df_hbox <- df_hbox %>% filter(duplicated(Subject.ID..NIAID.) == FALSE)

# Convert age to numeric
df_hbox <- df_hbox %>% 
  mutate(Age = gsub(" Years, ", "_", Age)) %>% 
  mutate(Age = gsub(" Months ", "", Age)) %>% 
  separate(Age, into = c("Years", "Months"), sep = "_") %>% 
  mutate(Years = as.numeric(Years)) %>% 
  mutate(Months = as.numeric(Months)/12) %>% 
  mutate(Age = Years + Months) %>% 
  dplyr::select(-c(Years, Months))

# Convert sex to factor
df_hbox <- df_hbox %>% mutate(Sex = as.factor(Sex))

# Trim for variables of interest (VOI)
df_hbox_trim <- df_hbox %>% 
  dplyr::select(c(Subject.ID..NIAID., Status, Glucose, Hematocrit, Lactate, Temperature,
                  Arginine.umol.L, Haptoglobin..mg.dl., Hemoglobin..uM., Whole.Blood.Nitrite, 
                  cerebral.hbdeox, cerebral.hbdeox.alpha, cerebral.hbox, cerebral.hbox.alpha,
                  cerebral.sat, cerebral.sat.alpha, cerebral.thc, cerebral.thc.alpha, cerebral.thc.norm.std)) %>% 
  
  dplyr::rename("subject_id" = "Subject.ID..NIAID.", "Arginine (umol/L)" = "Arginine.umol.L", "Haptoglobin (mg/dL)" = "Haptoglobin..mg.dl.", 
                "Hemoglobin (uM)" = "Hemoglobin..uM.", "WB_Nitrite" = "Whole.Blood.Nitrite", "DeoxyHb" = "cerebral.hbdeox", 
                "DeoxyHb_alpha" = "cerebral.hbdeox.alpha", "OxyHb" = "cerebral.hbox", "OxyHb_alpha" = "cerebral.hbox.alpha", 
                "O2sat" = "cerebral.sat", "O2sat_alpha" = "cerebral.sat.alpha", "THC" = "cerebral.thc", 
                "THC_alpha" = "cerebral.thc.alpha", "THC_sd" = "cerebral.thc.norm.std") 

# impute missing data with median by group
f_impute <- function(x, na.rm = TRUE) (replace(x, is.na(x), median(x, na.rm = na.rm)))

df_hbox_impute <- df_hbox_trim %>% 
  group_by(Status) %>% 
  mutate_at(3:ncol(.), f_impute) %>% 
  ungroup()

# pivot long
df_hbox_long <- df_hbox_trim %>% pivot_longer(cols = 3:ncol(.), names_to = "measurement", values_to = "value")

```

## Exploratory analysis

```{r voi}

# filter to just UM and CM
df_hbox_log <- df_hbox_impute %>% filter(Status != "HV") %>% select(-subject_id)

# select only VOI
df_hbox_log_voi <- df_hbox_log %>% select(1, 10:18)

# convert CM vs UM to 1 and 0
df_hbox_voi_01 <- df_hbox_log_voi %>% mutate(Status = ifelse(Status == "CM", 1, 0) %>% as.factor())

```

```{r voi_plot}

df_hbox_log_voi %>% pivot_longer(2:10, names_to = "variable", values_to = "value") %>% 
  
  ggplot(aes(x = Status, y = value)) +
  geom_violin(aes(color = Status)) +
  geom_jitter(position = position_jitter(0.2), shape = 1) +
  stat_summary(fun = "median", geom = "crossbar", aes(color = Status), size = 0.2, width = 0.5) +
  facet_wrap(~variable, scales = "free_y") +
  
  theme_bw() +
  theme(legend.position = "none")  +
  
  theme(strip.text = element_text(size = 15),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        axis.text = element_text(size = 15))
```

```{r histogram, fig.height = 6}

# histogram

df_hbox_log_voi %>% pivot_longer(2:10, names_to = "variable", values_to = "value") %>% 
  
  ggplot(aes(x = value)) +
  geom_histogram(bins = 20) +
  facet_grid(Status ~ variable, scales = "free") +
  
  theme(strip.text.y = element_text(size = 15),
        strip.text.x = element_text(size = 11),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 15),
        axis.text = element_text(size = 12),
        axis.text.x = element_text(angle = 45, hjust = 0.9))

```

## Variable correlations
```{r correlations, fig.show = "hold", out.width = "50%", fig.height = 12, fig.width = 15}

# calculate spearman correlations in each group

f_calc_cor <- function(df, status) {
  
  df_hbox_impute %>%
    filter(Status == status) %>% 
    dplyr::select(-c(subject_id, Status)) %>% 
    cor(method = "spearman")
  
}

m_cor_hv <- df_hbox_impute %>% f_calc_cor(status = "HV")

m_cor_um <- df_hbox_impute %>% f_calc_cor(status = "UM")

m_cor_cm <- df_hbox_impute %>% f_calc_cor(status = "CM")


# correlation matrix

  library(reshape)
  library(ggpubr)
  
  # write plot function
  f_plot_cor <- function(mat) {
    
    melt(mat) %>% 
      
      ggplot(aes(x = X1, y = X2, fill = value, label = round(value, 2))) + 
      geom_tile() +
      scale_fill_gradient2(low = "#4575b4", high = "#d73027") +
      geom_text(size = 6) +
      
      xlab("") +
      ylab("") +
      theme(axis.text.x = element_text(angle = 45, hjust = 0.9),
            axis.text = element_text(size = 25),
            legend.text = element_text(size = 40),
            legend.title = element_text(size = 50),
            legend.key.size = unit(2, 'cm'),
            plot.title = element_text(size = 30)
            )
    
  }
  
  # extract legend
  p_leg <- m_cor_hv %>% f_plot_cor() %>% get_legend()
  
  # create plots
  m_cor_hv %>% f_plot_cor() + ggtitle("HV variable correlations") + theme(legend.position = "none")
  
  m_cor_um %>% f_plot_cor() + ggtitle("UM variable correlations") + theme(legend.position = "none")
  
  m_cor_cm %>% f_plot_cor() + ggtitle("CM variable correlations") + theme(legend.position = "none")
  
  as_ggplot(p_leg)

```

## Logistic regression {.tabset}

### Explore data
```{r log_plot}

df_hbox_voi_01 %>% 
  pivot_longer(2:10, names_to = "variable", values_to = "value") %>% 
  mutate(Status = as.numeric(as.character(Status))) %>% 
  
  ggplot(aes(x = value, y = Status)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial")) +
  facet_wrap(~variable, scales = "free_x") +
  
  ylab("Status: 1 = CM, 0 = UM") +
  xlab("") +
  theme_bw()

```

### Model 1

#### Build

- logistic regression model
- variables: DeoxyHb, DeoxyHb_alpha, OxyHb, OxyHb_alpha, O2sat, O2sat_alpha, THC, THC_alpha, THC_sd
- bootstrap x100
- BoxCox transformation

```{r split_boot}

library(tidymodels)
library(rsample)

# split data
set.seed(123)
hbox_split <- initial_split(df_hbox_voi_01, strata = Status)
hbox_train <- training(hbox_split)
hbox_test <- training(hbox_split)

# resample
set.seed(234)
hbox_boot <- bootstraps(hbox_train, times = 100)

```

```{r model_spec}

# recipe
hbox_rec <- recipe(Status ~ ., data = hbox_train) %>% 
  step_BoxCox(all_predictors()) %>% 
  step_nzv(all_predictors())

# workflow
hbox_wf <- workflow() %>% 
  add_recipe(hbox_rec)

# logistic regression model spec
glm_spec <- logistic_reg() %>% 
  set_engine("glm")

```

```{r train_model}

glm_res <- hbox_wf %>% 
  add_model(glm_spec) %>%
  fit_resamples(
    resamples = hbox_boot,
    metrics = metric_set(roc_auc, accuracy, sensitivity, specificity),
    control = tune::control_resamples(save_pred = TRUE)
  )

```

#### Evaluate

Training data

```{r eval_training}
 
# collect metrics
collect_metrics(glm_res) %>% 
  dplyr::select(.metric, mean, n, std_err) %>% 
  as.data.frame()

# confusion matrix on training data
glm_res %>% 
  conf_mat_resampled() %>% 
  mutate(Prediction = ifelse(Prediction == 1, "CM", "UM")) %>% 
  mutate(Truth = ifelse(Truth == 1, "CM", "UM")) %>% 
  
  # plot
  ggplot(aes(x = Truth, y = Prediction, fill = Freq, label = Freq)) +
  geom_tile() +
  geom_text(size = 6) +
  scale_fill_gradient2(low = "#4575b4", high = "#d73027") +
  
  ggtitle("Confusion matrix: training data") +
  theme_bw()

```

```{r roc}

glm_res %>% 
  collect_predictions() %>% 
  group_by(id) %>% 
  roc_curve(Status, .pred_0) %>% 
  
  ggplot(aes(1 - specificity, sensitivity, color = id)) +
  geom_abline(lty = 2, color = "gray60", size = 1.5) +
  geom_path(show.legend = FALSE, alpha = 0.6, size = 1.2) +
  coord_equal() +
  ggtitle("ROC") +
  theme_bw()

```

Testing data
```{r test}

# fit to test data
hbox_final <- hbox_wf %>% 
  add_model(glm_spec) %>% 
  last_fit(hbox_split)

# compute metrics on testing data
collect_metrics(hbox_final) %>% 
  dplyr::select(-c(.estimator, .config)) %>% 
  as.data.frame()

# predictions
collect_predictions(hbox_final) %>% 
  count(.pred_class, Status) %>% 
  dplyr::rename("Prediction" = ".pred_class", "Truth" = "Status", "Freq" = "n") %>%  
  mutate(Prediction = ifelse(Prediction == 1, "CM", "UM")) %>% 
  mutate(Truth = ifelse(Truth == 1, "CM", "UM")) %>% 
  
  # plot
  ggplot(aes(x = Truth, y = Prediction, fill = Freq, label = Freq)) +
  geom_tile() +
  geom_text(size = 6) +
  scale_fill_gradient2(low = "#4575b4", high = "#d73027") +
  
  ggtitle("Confusion matrix: testing data") +
  theme_bw()

```

Coefficients
```{r coefficients}

hbox_final$.workflow[[1]] %>% 
  tidy() %>% 
  as.data.frame()

```

Odds ratios
```{r OR}

# OR
hbox_final$.workflow[[1]] %>% 
  tidy(exponentiate = TRUE) %>% 
  arrange(desc(estimate)) %>% 
  as.data.frame()

```

```{r plot_voi}

df_hbox_log_voi %>%
  
  ggplot(aes(x = THC_alpha, y = THC_sd, color = Status, fill = Status, size = O2sat_alpha)) +
  geom_point(alpha = 0.7) +
  stat_conf_ellipse(level = 0.95, npoint = 100, bary = TRUE, alpha = 0.1, geom = "polygon") +
  stat_mean(shape = 1, na.rm = FALSE) +
  ggtitle("VOI") +
  theme_bw()

```

### Model 2

#### Build

- logistic regression model
- variables: THC_alpha, THC_sd (O2sat_alpha was NS when included in model, p = 0.42)
- bootstrap x100
- BoxCox transformation

```{r split_boot2}

library(tidymodels)
library(rsample)

# select only significant variables
df_hbox_model2 <- df_hbox_voi_01 %>% dplyr::select(c(Status, THC_alpha, THC_sd))

# split data
set.seed(456)
hbox_split2 <- initial_split(df_hbox_model2, strata = Status)
hbox_train2 <- training(hbox_split2)
hbox_test2 <- training(hbox_split2)

# resample
set.seed(789)
hbox_boot2 <- bootstraps(hbox_train2, times = 100)

```

```{r model_spec2}

# recipe
hbox_rec2 <- recipe(Status ~ ., data = hbox_train2) %>% 
  step_BoxCox(all_predictors()) %>% 
  step_nzv(all_predictors())

# workflow
hbox_wf2 <- workflow() %>% 
  add_recipe(hbox_rec2)

# logistic regression model spec
glm_spec2 <- logistic_reg() %>% 
  set_engine("glm")

```

```{r train_model2}

glm_res2 <- hbox_wf2 %>% 
  add_model(glm_spec2) %>%
  fit_resamples(
    resamples = hbox_boot2,
    metrics = metric_set(roc_auc, accuracy, sensitivity, specificity),
    control = tune::control_resamples(save_pred = TRUE)
  )

```   

#### Evaluate

Training data

```{r eval_training2}

# collect metrics
collect_metrics(glm_res2) %>% 
  dplyr::select(.metric, mean, n, std_err) %>% 
  as.data.frame()

# confusion matrix on training data
glm_res2 %>% 
  conf_mat_resampled() %>% 
  mutate(Prediction = ifelse(Prediction == 1, "CM", "UM")) %>% 
  mutate(Truth = ifelse(Truth == 1, "CM", "UM")) %>% 
  
  # plot
  ggplot(aes(x = Truth, y = Prediction, fill = Freq, label = Freq)) +
  geom_tile() +
  geom_text(size = 6) +
  scale_fill_gradient2(low = "#4575b4", high = "#d73027") +
  
  ggtitle("Confusion matrix: training data") +
  theme_bw()

```

```{r roc2}

glm_res2 %>% 
  collect_predictions() %>% 
  group_by(id) %>% 
  roc_curve(Status, .pred_0) %>% 
  
  ggplot(aes(1 - specificity, sensitivity, color = id)) +
  geom_abline(lty = 2, color = "gray60", size = 1.5) +
  geom_path(show.legend = FALSE, alpha = 0.6, size = 1.2) +
  coord_equal() +
  ggtitle("ROC") +
  theme_bw()

```

Testing data
```{r test2}

# fit to test data
hbox_final2 <- hbox_wf2 %>% 
  add_model(glm_spec2) %>% 
  last_fit(hbox_split2)

# compute metrics on testing data
collect_metrics(hbox_final2) %>% 
  dplyr::select(-c(.estimator, .config)) %>% 
  as.data.frame()

# predictions
collect_predictions(hbox_final2) %>% 
  count(.pred_class, Status) %>% 
  dplyr::rename("Prediction" = ".pred_class", "Truth" = "Status", "Freq" = "n") %>%  
  mutate(Prediction = ifelse(Prediction == 1, "CM", "UM")) %>% 
  mutate(Truth = ifelse(Truth == 1, "CM", "UM")) %>% 
  
  # plot
  ggplot(aes(x = Truth, y = Prediction, fill = Freq, label = Freq)) +
  geom_tile() +
  geom_text(size = 6) +
  scale_fill_gradient2(low = "#4575b4", high = "#d73027") +
  
  ggtitle("Confusion matrix: testing data") +
  theme_bw()

```

Coefficients
```{r coefficients2}

hbox_final2$.workflow[[1]] %>% 
  tidy() %>% 
  as.data.frame()

```

Odds ratios
```{r OR2}

# OR
hbox_final2$.workflow[[1]] %>% 
  tidy(exponentiate = TRUE) %>% 
  arrange(desc(estimate)) %>% 
  as.data.frame()

```

```{r plot_voi2}

df_hbox_model2 %>% 
  
  ggplot(aes(x = THC_alpha, y = THC_sd, color = Status, fill = Status)) +
  geom_point(alpha = 0.7) +
  stat_conf_ellipse(level = 0.95, npoint = 100, bary = TRUE, alpha = 0.1, geom = "polygon") +
  stat_mean(shape = 1, na.rm = FALSE) +
  ggtitle("VOI") +
  theme_bw()
  
```





