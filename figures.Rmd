---
title: "Dysregulation of Cerebral Hemoglobin Content in Malawian Children with Malaria"
author: "Rachel Smith"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, comment = "", fig.height = 8, fig.width = 10)

library(tidyverse)
library(janitor)
library(factoextra)
library(ggrepel)
library(ggpubr)
library(tidymodels)
library(vip)
library(scales)
library(reshape)


load("model1.Rdata")
load("model2.Rdata")

```

```{r data}

# read in data
df_hbox <- read.csv("Data/98 first visit records with cerebral oxygenation stats_trimmed.csv") %>% as_tibble()

# get rid of "Other"
df_hbox <- df_hbox %>% 
  filter(Status != "Other") %>% 
  mutate(Status = factor(Status, levels = c("HV", "UM", "CM")))

# identify duplicated rows (TM0003, TM2001)
df_hbox <- df_hbox %>% filter(duplicated(Subject.ID..NIAID.) == FALSE)

# Convert age to numeric
df_hbox <- df_hbox %>% 
  mutate(Age = gsub(" Years, ", "_", Age)) %>% 
  mutate(Age = gsub(" Months ", "", Age)) %>% 
  separate(Age, into = c("Years", "Months"), sep = "_") %>% 
  mutate(Years = as.numeric(Years)) %>% 
  mutate(Months = as.numeric(Months)/12) %>% 
  mutate(Age = Years + Months) %>% 
  dplyr::select(-c(Years, Months))

# Convert sex to factor
df_hbox <- df_hbox %>% mutate(Sex = as.factor(Sex))

# Trim for variables of interest (VOI)
df_hbox_trim <- df_hbox %>% 
  dplyr::select(c(Subject.ID..NIAID., Status, Glucose, Hematocrit, Lactate, Temperature,
                  Arginine.umol.L, Haptoglobin..mg.dl., Hemoglobin..uM., 
                  BP.Diastolic, BP.Systolic, O2.Sat, RR, HR,
                  
                  cerebral.hbdeox, cerebral.hbdeox.alpha, cerebral.hbox, cerebral.hbox.alpha,
                  cerebral.sat, cerebral.sat.alpha, cerebral.thc, cerebral.thc.alpha)) %>% 
  
  dplyr::rename("subject_id" = "Subject.ID..NIAID.", 
                "Arginine (umol/L)" = "Arginine.umol.L", "Haptoglobin (mg/dL)" = "Haptoglobin..mg.dl.", 
                "Hemoglobin (uM)" = "Hemoglobin..uM.", "Lactate (mmol/L)" = "Lactate", "Hematocrit (%)" = "Hematocrit",
                "Systolic BP" = "BP.Systolic", "Diastolic BP" = "BP.Diastolic", "O2 sat" = "O2.Sat", 
                "Respiration rate" = "RR", "Heart rate" = "HR",
                
                "Deoxy Hb" = "cerebral.hbdeox", "Deoxy Hb α" = "cerebral.hbdeox.alpha", 
                "Oxy Hb" = "cerebral.hbox", "Oxy Hb α" = "cerebral.hbox.alpha",  
                "Cerebral O2 sat" = "cerebral.sat", "Cerebral O2 sat α" = "cerebral.sat.alpha", 
                "THC" = "cerebral.thc", "THCα" = "cerebral.thc.alpha") 

# Remove patients labeled as "UM" that instead meet the criteria for severe malaria

  # remove UM patient with lactate > 5 
  df_hbox_trim <- df_hbox_trim %>% dplyr::filter(!(Status == "UM" & `Lactate (mmol/L)` > 5))
  
  # All UM patients have hematocrit > 15%
  # df_hbox_trim %>% dplyr::filter(Status == "UM"  & `Hematocrit (%)` <= 15)
  
# impute missing data with median by group
f_impute <- function(x, na.rm = TRUE) (replace(x, is.na(x), median(x, na.rm = na.rm)))

df_hbox_impute <- df_hbox_trim %>% 
  group_by(Status) %>% 
  mutate_at(3:ncol(.), f_impute) %>% 
  ungroup()

# pivot long
df_hbox_long <- df_hbox_trim %>% pivot_longer(cols = 3:ncol(.), names_to = "variable", values_to = "value")

```

### Table 1: Summary of hematological data by patient group

```{r table1}

# number of subjects 
df_status <- df_hbox_impute %>% 
  count(Status) %>% 
  pivot_wider(1:2, names_from = "Status", values_from = "n") %>% 
  mutate(variable = "Number of subjects") %>% 
  dplyr::select(variable, everything()) %>% 
  mutate_if(is.numeric, as.character)

# Sex
df_sex <- df_hbox %>% 
  group_by(Status) %>% 
  count(Sex) %>% 
  filter(Sex != "") %>% 
  pivot_wider(names_from = "Sex", values_from = "n") %>% 
  mutate(perc_fem = round(Female/(Female + Male)*100, 2)) %>% 
  
  pivot_wider(c(1,4), names_from = "Status", values_from = "perc_fem") %>% 
  mutate(variable = "Sex (% female)") %>% 
  dplyr::select(variable, everything()) %>% 
  mutate_if(is.numeric, as.character)

# Age, hematocrit, and lactate
df_hbox %>% 
  
  group_by(Status) %>% 
  summarise(`Age (years)` = median(Age, na.rm = TRUE), age_range = range(Age, na.rm = TRUE),
            
            `Temperature (°C)` = median(Temperature, na.rm = TRUE), temp_range = range(Temperature, na.rm = TRUE),
            `Heart rate` = median(HR, na.rm = TRUE), hr_range = range(HR, na.rm = TRUE),
            `Systolic BP` = median(BP.Systolic, na.rm = TRUE), sys_range = range(BP.Systolic, na.rm = TRUE),
            `Diastolic BP` = median(BP.Diastolic, na.rm = TRUE), dia_range = range(BP.Diastolic, na.rm = TRUE),
            `Respiration rate` = median(RR, na.rm = TRUE), rr_range = range(RR, na.rm = TRUE),
            `O~2~ saturation` = median(O2.Sat, na.rm = TRUE), o2_range = range(O2.Sat, na.rm = TRUE),
            
            `Hematocrit (%)` = median(Hematocrit, na.rm = TRUE), hem_range = range(Hematocrit, na.rm = TRUE),
            `Lactate (mmol/L)` = median(Lactate, na.rm = TRUE), lactate_range = range(Lactate, na.rm = TRUE),
            `Arginine (μmol/L)` = median(Arginine.umol.L, na.rm = TRUE), arg_range = range(Arginine.umol.L, na.rm = TRUE)) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  
  mutate(`Age (years)` = paste0(`Age (years)`, " (", age_range[1], ", ", age_range[2], ")"),
         
         `Temperature (°C)` = paste0(`Temperature (°C)`, " (", temp_range[1], ", ", temp_range[2], ")"),
         `Heart rate` = paste0(`Heart rate`, " (", hr_range[1], ", ", hr_range[2], ")"),
         `Systolic BP` = paste0(`Systolic BP`, " (", sys_range[1], ", ", sys_range[2], ")"),
         `Diastolic BP` = paste0(`Diastolic BP`, " (", dia_range[1], ", ", dia_range[2], ")"),
         `Respiration rate` = paste0(`Respiration rate`, " (", rr_range[1], ", ", rr_range[2], ")"),
         `O~2~ saturation` = paste0(`O~2~ saturation`, " (", o2_range[1], ", ", o2_range[2], ")"),

         `Hematocrit (%)` = paste0(`Hematocrit (%)`, " (", hem_range[1], ", ", hem_range[2], ")"),
         `Lactate (mmol/L)` = paste0(`Lactate (mmol/L)`, " (", lactate_range[1], ", ", lactate_range[2], ")"),
         `Arginine (μmol/L)` = paste0(`Arginine (μmol/L)`, " (", arg_range[1], ", ", arg_range[2], ")")) %>% 
  dplyr::select(-c(age_range, temp_range, hr_range, sys_range, dia_range, rr_range, o2_range, hem_range, lactate_range, arg_range)) %>% 
  
  unique() %>% 
  t() %>% 
  row_to_names(row_number = 1) %>% 
  as_tibble(rownames = "variable") %>% 
  add_row(df_status, .before = 1) %>% 
  add_row(df_sex, .before = 2) %>% 
  
  dplyr::rename(" " = "variable",
                "Healthy volunteers (HV)" = "HV",
                "Uncomplicated malaria (UM) patients" = "UM",
                "Cerebral malaria (CM) patients" = "CM") %>% 
  knitr::kable(align = rep('c', 4))

```
**Table 1.** A summary of subject information and hematological data. Group patient data presented as median (range). Note: sex not recorded for 3 CM patients.

### Figure 1: Visual summary of NIRS variables

```{r fig1}

df_hbox_voi <- df_hbox_impute %>% 
  dplyr::select(c(Status, DeoxyHb, DeoxyHb_alpha, OxyHb, OxyHb_alpha, O2sat, O2sat_alpha, THC, THC_alpha, THC_sd)) %>% 
  dplyr::filter(DeoxyHb_alpha < 3) %>% 
  dplyr::rename("THC sd" = "THC_sd", "THCα" = "THC_alpha", "Deoxy Hb" = "DeoxyHb", "Oxy Hb" = "OxyHb", 
                "O2 sat" = "O2sat", "O2 sat α" = "O2sat_alpha", "Deoxy Hb α" = "DeoxyHb_alpha", "Oxy Hb α" = "OxyHb_alpha")

df_hbox_voi_long <- df_hbox_voi %>% 
  pivot_longer(2:10, names_to = "variable", values_to = "value") %>%
  mutate(variable = factor(variable, levels = c("Deoxy Hb", "Oxy Hb", "O2 sat", "THC", "THC sd", 
                                                "Deoxy Hb α", "Oxy Hb α", "O2 sat α", "THCα"))) 

my_col <- c("CM" = "#00BFC4", "HV" = "#7CAE00", "UM" = "#F8766D")
  
df_hbox_voi_long %>% 
  
  ggplot(aes(x = Status, y = value)) +
  geom_violin(aes(color = Status)) +
  geom_jitter(position = position_jitter(0.2), shape = 1) +
  stat_summary(fun = "median", geom = "crossbar", aes(color = Status), size = 0.2, width = 0.5) +
  facet_wrap(~variable, scales = "free_y") +
  
  scale_color_manual(values = my_col) +
  theme_bw() +
  theme(legend.position = "none")  +
  
  theme(strip.text = element_text(size = 15),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        axis.text = element_text(size = 15))

```
**Figure 1.** Differences in variables measured by Oxiplex and associated alpha values among patient groups. Note: removed one outlier from DeoxyHb alpha (3.52)

### Figure 3: Logistic regression on CM vs UM

#### A. PCA

```{r fig3a}
# select variables of interest
df_hbox_log_voi <- df_hbox_impute %>% 
  filter(Status != "HV") %>% 
  dplyr::select(2, 11:19)

# convert tibble to df
df_hbox_voi_df <- df_hbox_log_voi %>% 
  dplyr::select(-Status) %>% 
  dplyr::rename("THC sd" = "THC_sd", "THCα" = "THC_alpha", "Deoxy Hb" = "DeoxyHb", "Oxy Hb" = "OxyHb", 
                "O2 sat" = "O2sat", "O2 sat α" = "O2sat_alpha", "Deoxy Hb α" = "DeoxyHb_alpha", "Oxy Hb α" = "OxyHb_alpha") %>% 
  as.data.frame() 
rownames(df_hbox_voi_df) <- df_hbox_impute %>% dplyr::filter(Status != "HV") %>% .$subject_id

# compute PCA
my_pca2 <- prcomp(df_hbox_voi_df, scale = TRUE)

# define groups
groups2 <- as.factor(df_hbox_log_voi$Status)

# Eigenvalues
pca_eig_val2 <- get_eigenvalue(my_pca2)

# two data frames for plotting
df_vars2 <- my_pca2$rotation %>% as_tibble() %>% mutate(variable = rownames(my_pca2$rotation))
df_pnts2 <- my_pca2$x %>% as_tibble() %>% mutate(group = groups2) 

# plot

  # plot patients
  ggplot() +
  geom_point(data = df_pnts2, mapping = aes(x = PC1, y = PC2, color = group), 
             size = 3) +
  stat_conf_ellipse(data = df_pnts2, mapping = aes(x = PC1, y = PC2, color = group, fill = group),
                    level = 0.95, npoint = 100, bary = TRUE, alpha = 0.1, geom = "polygon") +
  stat_mean(data = df_pnts2, mapping = aes(x = PC1, y = PC2, color = group, shape = group),
            na.rm = FALSE) +
  
  # plot variables
  geom_point(data = df_vars2, aes(x = PC1*10, y = PC2*10)) +
  geom_text_repel(data = df_vars2, aes(x = PC1*10, y = PC2*10, label = variable, size = 10), show.legend = FALSE) +
  geom_segment(data = df_vars2, aes(x = 0, y = 0, xend = PC1*10, yend = PC2*10), arrow = arrow()) +

  # draw lines
  geom_vline(xintercept = 0, lty = 2, color = "black") +
  geom_hline(yintercept = 0, lty = 2, color = "black") +
  
  # design
  xlab(paste0("PC1: ", round(pca_eig_val2$variance.percent[1], 2), "% of variance")) +
  ylab(paste0("PC2: ", round(pca_eig_val2$variance.percent[2], 2), "% of variance")) +

  theme_bw() +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 25),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))

```

#### B. Confusion matrix

```{r fig3b_prep, eval = FALSE}

# convert to 0s and 1s
df_hbox_voi_01 <- df_hbox_log_voi %>% mutate(Status = ifelse(Status == "CM", 1, 0) %>% as.factor())

# select only significant variables
df_hbox_model2 <- df_hbox_voi_01 %>% 
  dplyr::select(c(Status, THC_alpha, THC_sd)) %>% 
  dplyr::rename("THCα" = "THC_alpha", "THC sd" = "THC_sd") %>% 
  mutate(`1/10 * THCα` = THCα/10) %>% 
  dplyr::select(-THCα)

# resample
set.seed(789)
hbox_boot2 <- bootstraps(df_hbox_model2, times = 1000)

# recipe
hbox_rec2 <- recipe(Status ~ ., data = df_hbox_model2) %>% 
  step_BoxCox(all_predictors()) %>% 
  step_nzv(all_predictors())

# workflow
hbox_wf2 <- workflow() %>% 
  add_recipe(hbox_rec2)

# logistic regression model spec
glm_spec2 <- logistic_reg() %>% 
  set_engine("glm")

glm_res2 <- hbox_wf2 %>% 
  add_model(glm_spec2) %>%
  fit_resamples(
    resamples = hbox_boot2,
    metrics = metric_set(roc_auc, accuracy, sensitivity, specificity),
    control = tune::control_resamples(save_pred = TRUE, verbose = TRUE)
  )

# select best model to be used for evaluation
glm_best2 <- glm_res2 %>% select_best("roc_auc")

# finalize model
hbox_final2 <- hbox_wf2 %>% 
  add_model(glm_spec2) %>% 
  finalize_workflow(glm_best2) %>%
  fit(df_hbox_model2) %>%
  pull_workflow_fit()

# save objects so model doesn't rerun 
save(glm_res2, hbox_final2, file = "model2.Rdata")

```   

```{r fig3b_plot}

final_res_conf_mat2 <- glm_res2 %>% 
  conf_mat_resampled() %>% 
  mutate(Prediction = ifelse(Prediction == 1, "CM", "UM")) %>% 
  mutate(Truth = ifelse(Truth == 1, "CM", "UM"))
  
final_res_conf_mat2 %>% 
  group_by(Truth) %>% 
  summarise(total_true = sum(Freq)) %>% 
  right_join(final_res_conf_mat2) %>% 
  mutate(`Percent occurence` = round(Freq/total_true*100, 2)) %>% 

  # plot
  ggplot(aes(x = Truth, y = Prediction, fill = `Percent occurence`, label = `Percent occurence`)) +
  geom_tile() +
  geom_text(size = 6) +
  scale_fill_gradient2(low = "#4575b4", high = "#d73027") +
  
  theme_bw() +
  theme(axis.title = element_text(size = 25),
        axis.text = element_text(size = 20),
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 15))

```

**Figure 3** Logistic regression model discriminating CM vs UM patients using only THCα and THC sd as predictors. **(A)** PCA of patients with CM and UM as determined by NIRS variables. Color indicates patient status, ellipses show median and 95% confidence interval on the cluster. **(B)** Confusion matrix representing the results of the logistic regression model averaged across 1000 bootstrap resamples. Freq indicates the average number of times that the event (shown by the x- and y-axes) occurred.

### Table 2. Logistic regression model evaluation

#### A. Model metrics
```{r table2a}

collect_metrics(glm_res2) %>% 
  dplyr::select(.metric, mean, std_err) %>% 
  mutate(mean = mean*100, std_err = std_err*100) %>% 
  mutate(Metric = c("Accuracy", "ROC AUC", "Sensitivity", "Specificity")) %>% 
  dplyr::select(c("Metric", "mean", "std_err")) %>% 
  
  dplyr::rename("Mean across resamples" = "mean", "Standard error" = "std_err") %>% 
  mutate_if(is.numeric, round, 2) %>% 
  as.data.frame() %>%
    
  knitr::kable(align = rep('c', 4))

```

#### B. Coefficients
```{r table2b}

hbox_final2 %>% 
  tidy() %>% 
  mutate(p.value = as.character(p.value)) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  mutate(p.value = as.numeric(p.value)) %>% 
  mutate(p.value = scientific(p.value, digits = 3)) %>% 
  dplyr::rename("Term" = "term", "Coefficient" = "estimate", "Standard error" = "std.error", 
                "Statistic" = "statistic", "p-value" = "p.value") %>% 
  
  as.data.frame() %>%
  knitr::kable(align = rep('c', 5))


```

**Table 2.** Evaluation of the logistic regression model across 1000 bootstrap resamples. 

### Supplementary figure 1: Variable correlations 
```{r fig_s1, fig.show = "hold", out.width = "50%", fig.height = 12, fig.width = 15}

# calculate spearman correlations in each group

f_calc_cor <- function(df, status) {
  
  df %>%
    filter(Status == status) %>% 
    dplyr::select(-Status) %>% 
    cor(method = "spearman")
  
}

df_hbox_cor <- df_hbox_impute %>% 
  dplyr::rename("THC sd" = "THC_sd", "THCα" = "THC_alpha", "Deoxy Hb" = "DeoxyHb", "Oxy Hb" = "OxyHb", 
                "O2 sat" = "O2sat", "O2 sat α" = "O2sat_alpha", "Deoxy Hb α" = "DeoxyHb_alpha", "Oxy Hb α" = "OxyHb_alpha") %>% 
  dplyr::select(Status, `Deoxy Hb`, `Oxy Hb`, `O2 sat`, THC, `THC sd`, `Deoxy Hb α`, `Oxy Hb α`, `O2 sat α`, THCα)

m_cor_hv <- df_hbox_cor %>% f_calc_cor(status = "HV")

m_cor_um <- df_hbox_cor %>% f_calc_cor(status = "UM")

m_cor_cm <- df_hbox_cor %>% f_calc_cor(status = "CM")

# correlation matrix

# write plot function
f_plot_cor <- function(mat) {
  
  melt(mat) %>% 
    
    mutate_if(is.factor, factor, levels = c("Deoxy Hb", "Oxy Hb", "O2 sat", "THC", "THC sd", "Deoxy Hb α", "Oxy Hb α", "O2 sat α", "THCα")) %>% 
    
    ggplot(aes(x = X1, y = X2, fill = value, label = round(value, 2))) + 
    geom_tile() +
    scale_fill_gradient2(low = "#4575b4", high = "#d73027") +
    geom_text(size = 9) +
    
    xlab("") +
    ylab("") +
    theme(axis.text.x = element_text(angle = 45, hjust = 0.9),
          axis.text = element_text(size = 35),
          legend.text = element_text(size = 40),
          legend.title = element_text(size = 50),
          legend.key.size = unit(2, 'cm'),
          plot.title = element_text(size = 30)
    )
  
}

  # extract legend
  p_leg <- m_cor_hv %>% f_plot_cor() %>% get_legend()
  
  # create plots
  m_cor_hv %>% f_plot_cor() + ggtitle("HV variable correlations") + theme(legend.position = "none")
  
  m_cor_um %>% f_plot_cor() + ggtitle("UM variable correlations") + theme(legend.position = "none")
  
  m_cor_cm %>% f_plot_cor() + ggtitle("CM variable correlations") + theme(legend.position = "none")
  
  as_ggplot(p_leg)

```

**Figure S1.** Shown are the spearman correlations among variables measured by Oxiplex and their associated alpha values. Red indicates a positive correlation; blue indicates a negative correlation.

### Supplementary figure 2: Logistic regression curves of NIRS variables
```{r fig_s2}

df_hbox_voi_long %>% mutate(Status = as.numeric(ifelse(Status == "CM", 1, 0))) %>% 
  
  ggplot(aes(x = value, y = Status)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial")) +
  facet_wrap(~variable, scales = "free_x") +
  
  ylab("Status: 1 = CM, 0 = UM") +
  xlab("") +
  
  theme_bw() +
  theme(axis.text = element_text(size = 20),
        axis.title = element_text(size = 25),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20),
        strip.text = element_text(size = 20))

```

**Figure S2.** Plotted are the individual logistic regression curves of individual variables tested for their discriminatory power between UM and CM. On the y-axis, 1 represents CM while 0 represents UM. A steeper curve indicates higher disciminatory power